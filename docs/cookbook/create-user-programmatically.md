# Создание пользователя программным способом

Иногда вам может потребоваться создать пользователя программным способом в коде, а не использовать конечную точку REST API. Для этого мы создадим функцию, которую вы сможете вызывать из вашего кода.

В этом контексте мы находимся вне механизма внедрения зависимостей FastAPI, поэтому нам придется заботиться о создании [`класса UserManager`](../configuration/user-manager.md) и всех других зависимых объектов **вручную**.

В этом рецепте мы предполагаем, что вы начинаете с [полного примера SQLAlchemy](../configuration/full-example.md), но подход будет довольно схож и для других СУБД.

## 1. Определение зависимостей как контекстных менеджеров

Обычно зависимости FastAPI определяются как **генераторы**, используя ключевое слово `yield`. FastAPI отлично умеет обращаться с ними внутри своей системы внедрения зависимостей. Вот пример определения зависимости `get_user_manager`:

```py
async def get_user_manager(user_db: SQLAlchemyUserDatabase = Depends(get_user_db)):
  yield UserManager(user_db)
```

В Python, когда мы хотим использовать генератор, мы должны использовать цикл `for`, что было бы немного неестественным в этом контексте, поскольку у нас есть всего одно значение, которое нужно получить - экземпляр менеджера пользователя. Чтобы избежать этого, мы преобразуем их в **контекстные менеджеры**, чтобы мы могли вызывать их, используя синтаксис `with..as`. К счастью, стандартная библиотека предоставляет инструменты для автоматического преобразования генераторов в контекстные менеджеры.

В следующем примере мы импортируем наши зависимости и создаем их версию в виде контекстного менеджера с использованием `contextlib.asynccontextmanager`:

```py
--8<-- "docs/src/cookbook_create_user_programmatically.py"
```

!!! info "У меня есть другие зависимости"
    Поскольку FastAPI Users полностью поддерживает внедрение зависимостей, у вас может быть больше аргументов, передаваемых в ваши зависимости базы данных или менеджера пользователей. Тогда важно не забыть ни одного. Еще раз подчеркиваем, что вне системы внедрения зависимостей вы сами отвечаете за создание **всего**.

## 2. Написание функции

Теперь мы готовы написать функцию. Приведенный ниже пример показывает вам базовый вариант, но вы, конечно же, можете адаптировать его под свои нужды. Основная часть здесь, как и раньше, состоит в том, чтобы **заботиться о создании каждого контекстного менеджера и передаче им необходимых аргументов**, как бы это делал менеджер зависимостей.

```py
--8<-- "docs/src/cookbook_create_user_programmatically.py"
```

## 3. Использование

Теперь вы легко можете использовать это в скрипте. Например:

```py
import asyncio

if __name__ == "__main__":
  asyncio.run(create_user("king.arthur@camelot.bt", "guinevere"))
```